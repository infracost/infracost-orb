version: "2.1"
description: "An orb wrapper for the infracost CLI tool"

aliases:
  - &step_download_infracost
    run:
      name: Download infracost
      command: |
        curl -L https://github.com/aliscott/infracost/releases/download/<<parameters.infracost_version>>/infracost-linux-amd64.tar.gz -o infracost.tar.gz \
          && tar -xvf infracost.tar.gz
  - &step_download_terraform
    run:
      name: Download terraform
      command: |
        curl -fsSL https://apt.releases.hashicorp.com/gpg | sudo apt-key add - \
          && sudo apt-add-repository "deb [arch=amd64] https://apt.releases.hashicorp.com $(lsb_release -cs) main" \
          && sudo apt-get update && sudo apt-get install terraform

orbs:
  infracost:
    executors:
      infracost_executor:
        docker:
          - image: cimg/base:2020.01
    jobs:
      run-infracost-report:
        executor: infracost_executor
        steps:
          - download-infracost
          - run-infracost-report
      save-infracost-json:
        executor: infracost_executor
        steps:
          - download-infracost
          - save-infracost-json
    commands:
      download-infracost:
        parameters:
          infracost_version:
            type: string
            default: v0.4.1
        steps:
          - *step_download_infracost
          - *step_download_terraform
      run-infracost-report:
        parameters:
          terraform_plan_file:
            type: string
          terraform_file_directory:
            type: string
        steps:
          - run: ./infracost-linux-amd64 --tfplan <<parameters.terraform_plan_file>> --tfdir <<parameters.terraform_file_directory>>
      save-infracost-json:
        parameters:
          terraform_plan_file:
            type: string
          terraform_file_directory:
            type: string
        steps:
          - run: mkdir -p /tmp/infracost/
          - run: ./infracost-linux-amd64 --tfplan <<parameters.terraform_plan_file>> --tfdir <<parameters.terraform_file_directory>> > /tmp/infracost/infracost.json
          - persist_to_workspace:
              root: /tmp/infracost
              paths: infracost.json

workflows:
  build:
    jobs:
      - infracost/run-infracost-report:
          name: run
      - infracost/save-infracost-json:
          name: json
