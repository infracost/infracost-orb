version: "2.1"
description: "An orb wrapper for the infracost CLI tool"

aliases:
  - &step_download_infracost
    run:
      name: Download infracost
      command: |
        curl -L https://github.com/aliscott/infracost/releases/<<parameters.infracost_version>>/download/infracost-linux-amd64.tar.gz -o infracost.tar.gz \
          && tar -xvf infracost.tar.gz
  - &step_download_terraform
    run:
      name: Download terraform
      command: |
        curl -fsSL https://apt.releases.hashicorp.com/gpg | sudo apt-key add - \
          && sudo apt-add-repository "deb [arch=amd64] https://apt.releases.hashicorp.com $(lsb_release -cs) main" \
          && sudo apt-get update && sudo apt-get install terraform

executors:
  infracost_executor:
    docker:
      - image: cimg/base:2020.01

jobs:
  run-infracost-report:
    executor: infracost_executor
    parameters:
      infracost_version:
        type: string
        default: latest
      terraform_plan_file:
        type: string
        default: plan.save
      terraform_file_directory:
        type: string
        default: terraform/
    steps:
      - checkout
      - download-infracost
      - run-infracost-report
  save-infracost-json:
    executor: infracost_executor
    parameters:
      infracost_version:
        type: string
        default: latest
      terraform_plan_file:
        type: string
        default: plan.save
      terraform_file_directory:
        type: string
        default: terraform/
    steps:
      - checkout
      - download-infracost
      - save-infracost-json

commands:
  download-infracost:
    parameters:
      infracost_version:
        type: string
        default: latest
    steps:
      - *step_download_infracost
      - *step_download_terraform
  run-infracost-report:
    parameters:
      terraform_plan_file:
        type: string
        default: plan.save
      terraform_file_directory:
        type: string
        default: terraform/
    steps:
      - run: terraform init <<parameters.terraform_file_directory>>
      - run: ./infracost-linux-amd64 --tfplan <<parameters.terraform_plan_file>> --tfdir <<parameters.terraform_file_directory>>
  save-infracost-json:
    parameters:
      terraform_plan_file:
        type: string
        default: plan.save
      terraform_file_directory:
        type: string
        default: terraform/
    steps:
      - run: terraform init <<parameters.terraform_file_directory>>
      - run: mkdir -p /tmp/infracost/
      - run: ./infracost-linux-amd64 --tfplan <<parameters.terraform_plan_file>> --tfdir <<parameters.terraform_file_directory>> > /tmp/infracost/infracost.json
      - persist_to_workspace:
          root: /tmp/infracost
          paths: infracost.json
